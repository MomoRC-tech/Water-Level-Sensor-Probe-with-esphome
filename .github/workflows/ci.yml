name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-esphome:
    runs-on: ubuntu-latest
    name: Validate ESPHome Configuration
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install ESPHome
      run: |
        python -m pip install --upgrade pip
        pip install esphome
      
    - name: Create secrets.yaml for validation
      run: |
        cat > secrets.yaml << 'EOF'
        wifi_ssid: "TestNetwork"
        wifi_password: "TestPassword123"
        ap_password: "APFallback123"
        ota_password: "TestOTA123"
        EOF
        
    - name: Validate YAML syntax
      run: esphome config waterlevel-sensor.yaml
      
    - name: Compile (dry-run)
      run: esphome compile waterlevel-sensor.yaml --dry-run

  lint:
    runs-on: ubuntu-latest
    name: Lint YAML Files
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install yamllint
      run: |
        python -m pip install --upgrade pip
        pip install yamllint
      
    - name: Lint YAML files
    
      run: |
        yamllint -d "{extends: relaxed, rules: {line-length: disable, trailing-spaces: disable}}" *.yaml
        yamllint -d "{extends: relaxed, rules: {line-length: disable, trailing-spaces: disable}}" .github/workflows/*.yml

  markdown-lint:
    runs-on: ubuntu-latest
    name: Lint Markdown
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create markdownlint config
      run: |
        cat > .markdownlint.json << 'EOF'
        {
          "line-length": { "line_length": 120 },
          "no-inline-html": false,
          "MD022": false,
          "MD032": false
        }
        EOF
        
    - name: Lint README
      uses: DavidAnson/markdownlint-cli2-action@v15
      with:
        globs: '**/*.md'
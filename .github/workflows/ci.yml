name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-esphome:
    name: Validate ESPHome Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ESPHome
        run: |
          python -m pip install --upgrade pip
          pip install esphome

      - name: Create secrets.yaml for validation
        run: |
          printf '%s\n' \
            'wifi_ssid: "TestNetwork"' \
            'wifi_password: "TestPassword123"' \
            'ap_password: "APFallback123"' \
            'ota_password: "TestOTA123"' \
            > secrets.yaml

      - name: Validate ESPHome syntax
        run: esphome config waterlevel-sensor.yaml

      - name: Compile (dry-run)
        run: esphome compile waterlevel-sensor.yaml --dry-run

  lint:
    name: Lint YAML Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yamllint
        run: |
          python -m pip install --upgrade pip
          pip install yamllint

      - name: Lint YAML files
        run: |
          yamllint -d "{extends: relaxed, rules: {line-length: disable, trailing-spaces: disable}}" waterlevel-sensor.yaml
          yamllint -d "{extends: relaxed, rules: {line-length: disable, trailing-spaces: disable}}" .github/workflows/ci.yml

  markdown-lint:
    name: Lint Markdown
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create markdownlint config
        run: |
          cat <<'EOF' > .markdownlint.json
          {
            "MD013": false,
            "MD022": false,
            "MD031": false,
            "MD032": false,
            "no-inline-html": false
          }
          EOF

      - name: Lint README
        uses: DavidAnson/markdownlint-cli2-action@v15
        with:
          globs: '**/*.md'
